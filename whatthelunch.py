# -*- coding: utf-8 -*-
"""whatthelunch.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1RbUuVcdC8UyvNhpS2hMNkkfBCV9_Q6LA
"""

from google.colab import drive
drive.mount('/content/drive')

import pandas as pd
import openpyxl
import random
import streamlit as st
from datetime import datetime

rootDir = '/content/drive/MyDrive/whatthelunch/'

def recom_restaurant():

  # ìŠ¤í”„ë ˆë“œ ì‹œíŠ¸ í˜¸ì¶œ
  store = openpyxl.load_workbook(rootDir + 'ys_store.xlsx')
  sheet_store_lst = store['ìŒì‹ì ë¦¬ìŠ¤íŠ¸']
  sheet_visit = store['ë°©ë¬¸ê¸°ë¡']
  sheet_reiview = store['ë¦¬ë·°']

  # ===========================================================================
  # ìŒì‹ì  ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°

  restaurant_lst = []
  for row in sheet_store_lst.iter_rows(min_row=2, values_only=True):
    if row[1]:
      restaurant_lst.append(row[1].strip())

  # ===========================================================================
  # ìµœê·¼ 5íšŒ ë°©ë¬¸í•œ ìŒì‹ì  ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°
  header = [cell.value for cell in sheet_visit[1][1:]]
  person_name = st.selectbox('ì´ë¦„ ì„ íƒ', header)

  if not person_name:
    st.warning('âš ï¸ì´ë¦„ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.')
    return

  full_header = [cell.value for cell in sheet_visit[1]]
  if person_name not in full_header:
    print(f"âš ï¸ '{person_name}' ì´ë¦„ì´ ë°©ë¬¸ê¸°ë¡ ì‹œíŠ¸ì— ì—†ìŠµë‹ˆë‹¤.")
    return

  cod_idx = full_header.index(person_name)+1
  visit_lst = []

  for row in sheet_visit.iter_rows(min_row=2, values_only=True):
    if row[0]:
      visit_lst.append(row[0])
  recent = visit_lst[-5:]

  st.write(f'ìµœê·¼ {person_name}ë‹˜ì˜ ë°©ë¬¸ ìŒì‹ì  : ', recent)

  # ===========================================================================
  # ìŒì‹ì  ëœë¤ ì¶”ì²œ

  # ì¶”ì²œí›„ë³´ í•„í„°ë§
  candidates = [r for r in restaurant_lst if r not in recent]
  if not candidates:
    st.warning('ì¶”ì²œí•  ìŒì‹ì ì´ ì—†ìŠµë‹ˆë‹¤. (ìµœê·¼ ë°©ë¬¸ ìŒì‹ì  ì œì™¸ ê¸°ì¤€)')
    return

  if 'recommend_pool' not in st.session_state:
    st.session_state.recommend_pool = candidates.copy()
  if 'current_choice' not in st.session_state:
    st.session_state.current_choice = None

  # ì¶”ì²œ ë²„íŠ¼
  if st.button('ì¶”ì²œ'):
    if not st.session_state.recommend_pool:
      st.warning('ì¶”ì²œí•  ìŒì‹ì ì´ ì—†ìŠµë‹ˆë‹¤. (ìµœê·¼ ë°©ë¬¸ ìŒì‹ì  ì œì™¸ ê¸°ì¤€)')
    else:
      st.session_state.current_choice = random.choice(st.session_state.recommend_pool)
      st.session_state.recommend_pool.remove(st.session_state.current_choice)

  # ì¶”ì²œ ê²°ê³¼
  if st.session_state.current_choice:
    st.success(f"ğŸ½ï¸ ì¶”ì²œ ìŒì‹ì : **{st.session_state.current_choice}**")

    # ì„ íƒ ë²„íŠ¼
    if st.button('ì´ ìŒì‹ì ìœ¼ë¡œ ì„ íƒ'):
      today = datetime.today().strftime('%Y-%m-%d')
      next_row = sheet_visit.max_row+1
      sheet_visit.cell(row=next_row, column=1).value = today
      sheet_visit.cell(row=next_row, column=cod_idx).value = st.session_state.current_choice
      store.save(rootDir+'ys_store.xlsx')
      st.success(f"âœ… {st.session_state.current_choice} ì €ì¥ ì™„ë£Œ!")

      # ì´ˆê¸°í™”
      del st.session_state.current_choice
      del st.session_state.recommend_pool

  # ===========================================================================
  #










recom_restaurant()

